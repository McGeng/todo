# COM ç»„ä»¶å¿«é€Ÿå‚è€ƒå¡ç‰‡

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥

### IUnknown ä¸‰å¤§æ–¹æ³•

```cpp
// 1. QueryInterface - æŸ¥è¯¢æ¥å£
HRESULT QueryInterface(REFIID riid, void** ppvObject);
// ä½œç”¨ï¼šè¯¢é—®å¯¹è±¡æ˜¯å¦æ”¯æŒæŸä¸ªæ¥å£
// è§„åˆ™ï¼šæˆåŠŸè¿”å›æ¥å£æŒ‡é’ˆåï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ AddRef

// 2. AddRef - å¢åŠ å¼•ç”¨è®¡æ•°
ULONG AddRef();
// ä½œç”¨ï¼šå‘Šè¯‰å¯¹è±¡"æœ‰ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯å¼€å§‹ä½¿ç”¨ä½ äº†"
// è§„åˆ™ï¼šæ¯æ¬¡è·å–æ¥å£æŒ‡é’ˆæ—¶è°ƒç”¨

// 3. Release - å‡å°‘å¼•ç”¨è®¡æ•°
ULONG Release();
// ä½œç”¨ï¼šå‘Šè¯‰å¯¹è±¡"æˆ‘ä¸å†ä½¿ç”¨ä½ äº†"
// è§„åˆ™ï¼šæ¯æ¬¡ä¸å†ä½¿ç”¨æ¥å£æŒ‡é’ˆæ—¶è°ƒç”¨
// ç‰¹æ®Šï¼šå¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œå¯¹è±¡ä¼šåˆ é™¤è‡ªå·±
```

### ä½¿ç”¨æ¨¡å¼

```cpp
// åˆ›å»ºå¯¹è±¡
IMyInterface* pObj = nullptr;
CreateObject(IID_IMyInterface, (void**)&pObj);

// ä½¿ç”¨å¯¹è±¡
pObj->SomeMethod();

// æŸ¥è¯¢å…¶ä»–æ¥å£ï¼ˆå¯é€‰ï¼‰
IOtherInterface* pOther = nullptr;
pObj->QueryInterface(IID_IOtherInterface, (void**)&pOther);
if (pOther) {
    pOther->DoSomething();
    pOther->Release();  // ç”¨å®Œå¿…é¡»é‡Šæ”¾
}

// é‡Šæ”¾å¯¹è±¡
pObj->Release();
pObj = nullptr;  // å¥½ä¹ æƒ¯ï¼šé˜²æ­¢æ‚¬ç©ºæŒ‡é’ˆ
```

## ğŸ“‹ COM ç¼–ç¨‹é»„é‡‘è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **è§„åˆ™ 1** | æ¯æ¬¡ `QueryInterface` æˆåŠŸåï¼Œå¼•ç”¨è®¡æ•° +1 |
| **è§„åˆ™ 2** | è°æ‹¿åˆ°æ¥å£æŒ‡é’ˆï¼Œè°è´Ÿè´£è°ƒç”¨ `Release` |
| **è§„åˆ™ 3** | `AddRef` å’Œ `Release` å¿…é¡»æˆå¯¹å‡ºç° |
| **è§„åˆ™ 4** | æ¥å£æŒ‡é’ˆå¯ä»¥å¤åˆ¶ï¼Œä½†æ¯ä¸ªå‰¯æœ¬éƒ½è¦ `AddRef` |
| **è§„åˆ™ 5** | å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œå¯¹è±¡è‡ªåŠ¨é”€æ¯ |

## ğŸ” HRESULT å¸¸ç”¨è¿”å›å€¼

```cpp
S_OK            // æˆåŠŸ
S_FALSE         // æˆåŠŸä½†æœ‰ç‰¹æ®Šå«ä¹‰
E_FAIL          // ä¸€èˆ¬æ€§å¤±è´¥
E_POINTER       // ç©ºæŒ‡é’ˆé”™è¯¯
E_INVALIDARG    // æ— æ•ˆå‚æ•°
E_OUTOFMEMORY   // å†…å­˜ä¸è¶³
E_NOINTERFACE   // ä¸æ”¯æŒè¯·æ±‚çš„æ¥å£
E_NOTIMPL       // æ–¹æ³•æœªå®ç°

// æ£€æŸ¥å®
SUCCEEDED(hr)   // hr æ˜¯å¦è¡¨ç¤ºæˆåŠŸ
FAILED(hr)      // hr æ˜¯å¦è¡¨ç¤ºå¤±è´¥
```

## ğŸ› ï¸ å¸¸ç”¨ä»£ç ç‰‡æ®µ

### å®šä¹‰æ¥å£

```cpp
// å®šä¹‰æ¥å£ ID (GUID)
static const IID IID_IMyInterface =
{ 0x12345678, 0x1234, 0x5678,
  { 0x12, 0x34, 0x56, 0x78, 0x9A, 0xBC, 0xDE, 0xF0 } };

// å®šä¹‰æ¥å£
class __declspec(novtable) IMyInterface : public IUnknown
{
public:
    virtual HRESULT __stdcall MyMethod(int param) = 0;
};
```

### å®ç° QueryInterface

```cpp
HRESULT __stdcall MyClass::QueryInterface(REFIID riid, void** ppvObject)
{
    if (!ppvObject) return E_POINTER;
    *ppvObject = nullptr;

    if (riid == IID_IUnknown) {
        *ppvObject = static_cast<IMyInterface*>(this);
    }
    else if (riid == IID_IMyInterface) {
        *ppvObject = static_cast<IMyInterface*>(this);
    }
    else {
        return E_NOINTERFACE;
    }

    AddRef();
    return S_OK;
}
```

### å®ç° AddRef å’Œ Release

```cpp
ULONG __stdcall MyClass::AddRef()
{
    return ++m_refCount;
}

ULONG __stdcall MyClass::Release()
{
    ULONG count = --m_refCount;
    if (count == 0) {
        delete this;
        return 0;
    }
    return count;
}
```

## âš¡ è°ƒè¯•æŠ€å·§

### 1. æ·»åŠ è°ƒè¯•è¾“å‡º

```cpp
std::cout << "[COM] AddRef, count = " << m_refCount << std::endl;
std::cout << "[COM] Release, count = " << m_refCount << std::endl;
```

### 2. æ£€æŸ¥å¼•ç”¨è®¡æ•°æ³„æ¼

- ç¨‹åºç»“æŸå‰ï¼Œæ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åº”è¯¥ä¸º 0
- å¦‚æœå¼•ç”¨è®¡æ•°ä¸ä¸º 0ï¼Œè¯´æ˜æœ‰ `Release` æœªè°ƒç”¨

### 3. ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼ˆé«˜çº§ï¼‰

```cpp
// ATL æä¾›çš„æ™ºèƒ½æŒ‡é’ˆ
CComPtr<IMyInterface> spObj;
CreateObject(IID_IMyInterface, (void**)&spObj);
// è‡ªåŠ¨è°ƒç”¨ Releaseï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†
```

## ğŸš« å¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šå¿˜è®° Release

```cpp
âŒ é”™è¯¯ï¼š
pObj->SomeMethod();
// å¿˜è®°è°ƒç”¨ Releaseï¼Œå¯¼è‡´å†…å­˜æ³„æ¼

âœ… æ­£ç¡®ï¼š
pObj->SomeMethod();
pObj->Release();
```

### é”™è¯¯ 2ï¼šRelease åç»§ç»­ä½¿ç”¨

```cpp
âŒ é”™è¯¯ï¼š
pObj->Release();
pObj->SomeMethod();  // æ‚¬ç©ºæŒ‡é’ˆï¼

âœ… æ­£ç¡®ï¼š
pObj->Release();
pObj = nullptr;
```

### é”™è¯¯ 3ï¼šQueryInterface åå¿˜è®° Release

```cpp
âŒ é”™è¯¯ï¼š
IUnknown* pUnk = nullptr;
pObj->QueryInterface(IID_IUnknown, (void**)&pUnk);
// å¿˜è®°é‡Šæ”¾ pUnk

âœ… æ­£ç¡®ï¼š
IUnknown* pUnk = nullptr;
pObj->QueryInterface(IID_IUnknown, (void**)&pUnk);
pUnk->Release();
```

## ğŸ“Š å¼•ç”¨è®¡æ•°è¿½è¸ªç¤ºä¾‹

```
åˆ›å»ºå¯¹è±¡:         count = 1
QueryInterface:   count = 2
Release:          count = 1
Release:          count = 0 â†’ å¯¹è±¡é”€æ¯
```

## ğŸ“ å­¦ä¹ è·¯å¾„

1. âœ… ç†è§£ IUnknown ä¸‰å¤§æ–¹æ³•
2. âœ… æŒæ¡å¼•ç”¨è®¡æ•°æœºåˆ¶
3. âœ… å­¦ä¼šå®šä¹‰å’Œå®ç°æ¥å£
4. âœ… ç»ƒä¹ åˆ›å»ºå’Œä½¿ç”¨ COM å¯¹è±¡
5. â¬œ å­¦ä¹  ATL ç®€åŒ–å¼€å‘
6. â¬œ äº†è§£ COM æœåŠ¡å™¨ç±»å‹ï¼ˆDLL/EXEï¼‰
7. â¬œ æŒæ¡ COM ç»„ä»¶æ³¨å†Œ
8. â¬œ å­¦ä¹ è‡ªåŠ¨åŒ–æ¥å£ (IDispatch)

---

**æç¤º**: æŠŠè¿™ä¸ªæ–‡ä»¶æ‰“å°å‡ºæ¥æ”¾åœ¨æ‰‹è¾¹ï¼Œç¼–å†™ COM ä»£ç æ—¶éšæ—¶å‚è€ƒï¼
